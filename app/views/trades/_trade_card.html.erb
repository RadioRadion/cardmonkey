<%# app/views/trades/index.html.erb %>
<%= turbo_stream_from current_user, :trades %>

<div class="max-w-7xl mx-auto px-4 py-8">
  <div class="sm:flex sm:items-center">
    <div class="sm:flex-auto">
      <h1 class="text-2xl font-semibold text-gray-900">Mes échanges</h1>
    </div>
  </div>

  <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
    <%# Trades en attente %>
    <% if @trades['0'].present? %>
      <%= turbo_frame_tag "pending_trades" do %>
        <section class="trades-section">
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 bg-white border-b border-gray-200">
              <h2 class="flex items-center">
                <span class="text-lg font-medium text-gray-900">En attente</span>
                <span class="ml-2 bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                  <%= @trades['0'].size %>
                </span>
              </h2>
            </div>
            
            <div class="divide-y divide-gray-200">
              <% @trades['0'].each do |trade| %>
                <%= turbo_frame_tag trade do %>
                  <%= render "trade_row", trade: trade %>
                <% end %>
              <% end %>
            </div>
          </div>
        </section>
      <% end %>
    <% end %>

    <%# Trades acceptés %>
    <% if @trades['1'].present? %>
      <%= turbo_frame_tag "accepted_trades" do %>
        <section class="trades-section">
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 bg-white border-b border-gray-200">
              <h2 class="flex items-center">
                <span class="text-lg font-medium text-gray-900">Acceptés</span>
                <span class="ml-2 bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                  <%= @trades['1'].size %>
                </span>
              </h2>
            </div>
            
            <div class="divide-y divide-gray-200">
              <% @trades['1'].each do |trade| %>
                <%= turbo_frame_tag trade do %>
                  <%= render "trade_row", trade: trade %>
                <% end %>
              <% end %>
            </div>
          </div>
        </section>
      <% end %>
    <% end %>

    <%# Trades terminés %>
    <% if @trades['2'].present? %>
      <%= turbo_frame_tag "completed_trades" do %>
        <section class="trades-section">
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 bg-white border-b border-gray-200">
              <h2 class="flex items-center">
                <span class="text-lg font-medium text-gray-900">Terminés</span>
                <span class="ml-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                  <%= @trades['2'].size %>
                </span>
              </h2>
            </div>
            
            <div class="divide-y divide-gray-200">
              <% @trades['2'].each do |trade| %>
                <%= turbo_frame_tag trade do %>
                  <%= render "trade_row", trade: trade %>
                <% end %>
              <% end %>
            </div>
          </div>
        </section>
      <% end %>
    <% end %>
  </div>
</div>

<%# app/views/trades/_trade_row.html.erb %>
<div class="p-4 hover:bg-gray-50">
  <div class="flex items-center justify-between">
    <div class="min-w-0 flex-1">
      <div class="flex items-center gap-2">
        <%= trade.status_badge %>
        <p class="truncate font-medium text-gray-900">
          avec <%= trade.partner_name_for(current_user) %>
        </p>
      </div>
      
      <%# Infos sur les cartes %>
      <div class="mt-1 flex items-center gap-4 text-sm text-gray-500">
        <% user_cards = trade.trade_user_cards.joins(:user_card).where(user_cards: { user_id: current_user.id }) %>
        <% partner_cards = trade.trade_user_cards.joins(:user_card).where.not(user_cards: { user_id: current_user.id }) %>
        
        <span><%= pluralize(user_cards.count, 'carte') %> proposée(s)</span>
        <span>•</span>
        <span><%= pluralize(partner_cards.count, 'carte') %> demandée(s)</span>
      </div>

      <p class="mt-1 text-sm text-gray-500">
        <%= time_ago_in_words(trade.updated_at) %>
      </p>
    </div>
    
    <div class="flex items-center gap-4">
      <%= link_to trade_path(trade), 
          class: "inline-flex items-center rounded-lg text-sm font-semibold text-blue-600 hover:text-blue-800",
          data: { turbo_frame: "_top" } do %>
        Voir détails
        <svg class="ml-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
        </svg>
      <% end %>
    </div>
  </div>

  <%# Actions pour les trades en attente %>
  <% if trade.status == "0" && trade.user_id_invit == current_user.id %>
    <div class="mt-4 flex items-center gap-3">
      <%= button_to trade_path(trade, status: "accepted"),
          method: :patch,
          class: "rounded-md bg-blue-600 px-3.5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500" do %>
        Accepter l'échange
      <% end %>

      <%= button_to trade_path(trade, status: "rejected"),
          method: :patch,
          class: "rounded-md bg-white px-3.5 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" do %>
        Refuser
      <% end %>
    </div>
  <% end %>
</div>